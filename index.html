<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <title>WebXR App</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
    <link
      rel="stylesheet"
      href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css"
      type="text/css"
    />
    <title>Google Maps Clone</title>
    <style>
      body {
        margin: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      #map {
        position: absolute;
        height: 50vh;
        width: 100vw;
      }
      #arButton {
        position: relative;
        margin-top: 10px;
        text-align: center;
        padding: 10px;
        background-color: #fff;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
      }

      #startArButton {
        text-decoration: none;
        color: #333;
      }
    </style>
  </head>
  <script>
    mapboxgl.accessToken =
      "pk.eyJ1Ijoic3ViaGFtcHJlZXQiLCJhIjoiY2toY2IwejF1MDdodzJxbWRuZHAweDV6aiJ9.Ys8MP5kVTk5P9V2TDvnuDg";

    let map;
    let userMarker;
    let directions;

    navigator.geolocation.getCurrentPosition(successLocation, errorLocation, {
      enableHighAccuracy: true,
    });

    function successLocation(position) {
      const userLocation = [position.coords.longitude, position.coords.latitude];
      setupMap(userLocation);

      userMarker = new mapboxgl.Marker().setLngLat(userLocation).addTo(map);

      navigator.geolocation.watchPosition(
        updateUserLocation,
        errorLocation,
        {
          enableHighAccuracy: true,
        }
      );
    }

    function updateUserLocation(position) {
      const updatedUserLocation = [position.coords.longitude, position.coords.latitude];
      userMarker.setLngLat(updatedUserLocation);
    }

    function errorLocation() {
      setupMap([-2.24, 53.48]);
    }

    function postRouteData(startLocation, endLocation, detailedRouteDetails) {
      const data = {
        startLocation: startLocation,
        endLocation: endLocation,
        detailedRouteDetails: detailedRouteDetails,
      };

      localStorage.setItem('routeData', JSON.stringify(data));
    }

    function setupMap(center) {
      map = new mapboxgl.Map({
        container: "map",
        style: "mapbox://styles/mapbox/streets-v11",
        center: center,
        zoom: 15,
      });

      map.on("load", function () {
        const nav = new mapboxgl.NavigationControl();
        map.addControl(nav);

        directions = new MapboxDirections({
          accessToken: mapboxgl.accessToken,
          profile: 'mapbox/walking',
        });

        map.addControl(directions, "top-left");
        const marker = new mapboxgl.Marker().setLngLat(center).addTo(map);

        map.on("click", function (e) {
          // Get the clicked location coordinates
          const clickedLocation = [e.lngLat.lng, e.lngLat.lat];

          // Set the destination for directions
          directions.setDestination(clickedLocation);

          // Trigger route calculation
          directions.query();

          // Clear previous markers
          map.getSource('user-marker').setData({
            type: 'Point',
            coordinates: center,
          });

          // Add marker for the clicked location
          map.getSource('user-marker').setData({
            type: 'Point',
            coordinates: clickedLocation,
          });

          // Now attach the 'route' event listener
          directions.on("route", function (event) {
            const startLocation = center;
            const endLocation = clickedLocation;

            console.log("Start Location:", startLocation);
            console.log("End Location:", endLocation);

            const detailedRouteDetails = event.route[0].legs[0].steps.map(
              (step, index) => ({
                instruction: step.maneuver.instruction,
                distance: step.distance,
                duration: step.duration,
                location: {
                  longitude: step.maneuver.location[0],
                  latitude: step.maneuver.location[1],
                },
                maneuver: step.maneuver,
                geometry: step.geometry,
                intersections: step.intersections,
                travel_mode: step.travel_mode,
                maneuver_type: step.maneuver.type,
                step_index: index,
              })
            );

            console.log("Detailed Route Details:", detailedRouteDetails);
            postRouteData(startLocation, endLocation, detailedRouteDetails);
          });
        });

        // Add a GeoJSON source for the user marker
        map.addSource('user-marker', {
          type: 'geojson',
          data: {
            type: 'Point',
            coordinates: center,
          },
        });

        // Add a layer for the user marker
        map.addLayer({
          id: 'user-marker',
          source: 'user-marker',
          type: 'symbol',
          layout: {
            'icon-image': 'marker-15', // Use a predefined icon
            'icon-allow-overlap': true,
          },
        });
      });
    }
  </script>
  <body>
    <div id='map'></div>

    <div id="arButton">
      <a href="/app.html" id="startArButton">Start AR</a>
    </div>
  </body>
</html>
